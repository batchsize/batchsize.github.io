# onnx 量化

onnx



# 量化样本数

这是一个非常好的问题 👍。

在做 **模型量化 (Quantization)** 时，是否要在 **校准集 (calibration dataset)** 里加入 **背景负样本**，取决于你量化的目标和场景：

---

## 📌 1. 为什么需要考虑背景负样本

* **量化的本质**：是用校准集里的数据分布来确定激活值和权重的量化范围（min/max 或统计分布）。
* 如果校准集只包含 **正样本（目标很清晰的图片）**，那么模型在推理背景图时，可能出现：

  * 激活分布不覆盖真实运行时的范围 → **截断/溢出**，导致误差变大；
  * 背景类（negative）特征没有被校准 → 在部署时误检或置信度异常。

---

## 📌 2. 是否应该加入负样本

* **目标检测 / 分类模型**
  ✅ 推荐加入负样本，特别是推理场景里会遇到很多没有目标的图片。这样能让量化校准覆盖真实输入分布，提升稳定性。

* **图像分割 / 其他视觉任务**
  如果推理时背景场景多样，负样本同样有帮助。

* **只有目标裁剪（crop）作为输入**
  如果部署时输入永远是裁剪后的 ROI（几乎没有背景），那么负样本的必要性不大。

---

## 📌 3. 实际建议

* **保持量化集分布 ≈ 真实推理分布**，这是最关键原则。
* 如果实际推理时会遇到大量纯背景帧，**一定要在校准集中加一部分背景负样本**（比例可以少一些，比如 10\~30%）。
* 如果模型是只做目标区域输入，那可以不加。

---

✅ 总结：
量化集最好和真实部署场景的数据分布一致，如果你的模型在推理时会遇到背景图，那么 **应该在量化集里加入一些背景负样本**，这样量化范围才更合理，模型在部署时更稳。

要不要我帮你给一个 **推荐的量化集构建比例方案**（比如多少正样本，多少负样本）？



好嘞！给你一套**可直接落地的量化校准集构建比例方案**（默认 INT8 PTQ，目标检测为主；分类/分割也给了参考）。核心原则是：校准集的输入分布 ≈ 实际线上分布。

# 建议规模

* **总量**：**500–1000 张**（足够让激活分布稳定；>2000 收益递减）。
* **来源**：覆盖不同时间/天气/场景/设备与压缩质量。

# 目标检测（推荐）

* **常规正样本**（有目标、常见姿态/距离/遮挡）：**60–70%**
* **困难正样本**（弱光/逆光、雨雾、模糊、远小目标、强遮挡、严重压缩）：**15–25%**
* **纯背景负样本**（无任何目标）：**10–20%** ← 这是你问的重点

> 例子
>
> * 若总计 **800 张**：常规 520、困难 160、背景 120。
> * 若总计 **1200 张**：常规 780、困难 240、背景 180。

# 分类（参考）

* **封闭集、输入几乎总有目标**：背景负样本 **0–5%** 即可。
* **线上会出现空场景/无目标帧**：背景负样本 **10–20%**。

# 语义/实例分割（参考）

* 若线上会出现**全背景/空掩码**帧：空掩码样本 **10–15%**。
* 其余与检测类似（常规 + 困难分布）。

# 负样本怎么选（务实清单）

* 覆盖**真实线上**会遇到的空场景：纯路面、天空、墙面、无车无人等。
* 加入**复杂背景**：强纹理（草丛、栅栏）、强反光、电子屏、广告牌、玻璃反射。
* 加入**视频压缩产物**：高/低码率各占一部分（如 JPG 质量 40/80 混合）。
* 加入**极端光照**：夜间、背光、过曝、阴影。
* 采样自视频时：**等间隔抽帧**+剔除连续近重复（可用感知哈希/简单直方图阈值）。

# 采样与去重小技巧

* 每段视频间隔 0.5–2 秒抽 1 帧；不同路段/机位/时间都要覆盖。
* 去重：同一机位连续帧相似度 >0.98 的只留 1 张（避免校准统计被相似帧“刷屏”）。
* 类别均衡：若多类目标，正样本尽量让**每类都在校准集出现**（哪怕只占少量）。

# 标注是否必须？

* **不强制**。校准只看**像素分布**，不看标签。
* 但用“困难正样本”时，建议确认确实**包含目标**，避免把误以为有目标的背景错归为“正样本”。

# 量化细节与参数建议

* **校准方法**：KL、Percentile（如 99.9%）或 MinMax with outlier clipping。若背景占比提升，Percentile 往往更稳。
* **批大小**：1–32，关键是把**所有校准图跑一遍**（顺序可打乱）。
* **预处理**：与线上完全一致（resize、letterbox、归一化、颜色通道、mean/std）。
* **动态范围稳定性**：跑两遍统计对比 max/min 差异；差异大说明样本不足或分布失真。

# 两个现成配方（拿走即用）

**配方 A（检测，800 张）：**

* 常规正样本 520（各类目标都出现）
* 困难正样本 160（低光/雨雾/远小/模糊/强压缩各占不少于 20 张）
* 背景负样本 120（道路/天空/墙面/玻璃反射/屏幕/强纹理各 ≥15 张）

**配方 B（检测，1200 张，线上空场景较多）：**

* 常规正样本 720
* 困难正样本 240
* 背景负样本 240（其中低码率压缩背景 ≥80 张）

---

如果你告诉我**线上实际比例**（比如多少场景是空帧、白天/夜间、摄像头数、码率范围），我可以把上面的比例再为你**精调到更贴近你的分布**，并给出一份“逐类/逐条件”的抽样清单。


好的👌，我给你设想一个**真实的部署场景例子**，然后套用上面的方法，把量化集比例具体化。

---

## 🎯 场景设定：

这是一个车载前视 ADAS 摄像头的目标检测模型，要检测以下目标：

* `person`、`vehicle`、`traffic light`、`helmet`

### 部署环境：

* 摄像头分辨率：1920×1080，部署推理时会 resize 到 1280×720。
* 工作时长：全天候（白天/夜晚）。
* 典型场景：

  * **高速路**（大部分时间没有行人，偶尔有车）
  * **城区道路**（行人、红绿灯、摩托车/电动车、骑手戴/不戴头盔）
  * **停车场/小区道路**（车辆和行人混杂）
  * **纯背景帧**：比如夜间空旷高速、隧道里空帧。
* 视频压缩：JPG 保存质量 70–90，但偶尔会遇到码率很低的场景（压缩伪影明显）。

---

## 📊 量化校准集构建（1000 张为例）

### 1. 正常正样本（600 张，≈60%）

覆盖常见场景下的典型目标：

* 车辆（小轿车、大货车、公交车）：**300 张**
* 行人（正常行走、过马路）：**150 张**
* 红绿灯（白天、夜晚都有）：**100 张**
* 骑摩托车/电动车的人（带头盔/不带头盔）：**50 张**

### 2. 困难正样本（200 张，≈20%）

覆盖极端或难点情况：

* 夜晚弱光、逆光、强背光：**50 张**
* 雨天/雾天/反光玻璃：**50 张**
* 远小目标（比如远处的行人/车只占 10×20 像素）：**50 张**
* 模糊/压缩严重（JPG Q=30–40）：**50 张**

### 3. 背景负样本（200 张，≈20%）

没有任何目标的场景：

* 空高速路（白天/夜晚各 50 张）：**100 张**
* 隧道内部（只有灯光/墙壁）：**50 张**
* 天空/草地/建筑墙面（强纹理背景）：**30 张**
* 大屏广告牌/LED 显示屏（容易误检）：**20 张**

---

## 🚦 校准集效果

* 模型的量化范围不仅覆盖了常见的前景激活分布，还覆盖了**空场景的特征分布**。
* 避免了模型在夜间空高速路、隧道场景下因**缺少负样本**而出现激活溢出或误检概率飙升。
* 正/困难/背景三类样本的比例 **6:2:2**，比较平衡，适合实际部署。

---

要不要我帮你再写一个**工厂监控场景**（比如安全帽/安全衣检测）的量化集方案？这样你就能对比车载 vs 工厂的差异。


好～下面给你一个**工厂监控（PPE 安全合规）场景**的量化校准集方案，可直接照抄落地。目标包含：`person / helmet / safety vest / forklift / vehicle`，并且要稳住“无目标/空产线”时的误检。

# 场景假设

* 摄像头：固定枪机与半球混合，分辨率 2560×1440，线上推理统一 resize 到 **1280×720**。
* 画面：产线、仓库通道、装卸区、门岗。
* 环境：白天自然光、夜间厂内灯、强背光（卷帘门/玻璃门）、焊接强光、反光金属。
* 压缩：RTSP/H.264（VBR，低码率时有块效应）；也有 JPG 抓拍（质量 60–90）。

---

# 推荐规模与比例

给两个配方（**600 张**与**1000 张**），比例一致：**常规正样本 60% / 困难正样本 20% / 背景负样本 20%**

## 配方 A：600 张

* **常规正样本（360，60%）**

  * 员工佩戴安全帽+马甲：**150**
  * 未佩戴/佩戴不规范（帽带松）：**60**
  * 叉车/牵引车/小车：**60**
  * 多人重叠/正常巡检：**60**
  * 站岗/门禁场景（门口进出）：**30**
* **困难正样本（120，20%）**

  * 逆光/背光（卷帘门、玻璃门口）：**30**
  * 夜间/暗光/局部照明：**30**
  * 强反光金属、荧光马甲过曝：**20**
  * 焊接火花/屏幕/LED 招牌干扰：**20**
  * 远小目标（人高 < 40px）、运动模糊/低码率：**20**
* **背景负样本（120，20%）**（无任何目标）

  * 空产线/空工位/空通道：**50**
  * 只有码垛托盘/货架/机器手臂：**40**
  * 纯背景高纹理（栅栏、格栅、警示条纹、贴纸墙）：**20**
  * LED 看板/监控画中画/反射镜面：**10**

## 配方 B：1000 张

* **常规正样本（600）**

  * 员工佩戴：**260**
  * 未佩戴/不规范：**100**
  * 叉车/车辆：**100**
  * 多人重叠：**100**
  * 门禁/通道：**40**
* **困难正样本（200）**

  * 背光：**50**；暗光：**50**
  * 强反光/过曝：**30**
  * 焊接火花/屏幕干扰：**30**
  * 远小目标+低码率/模糊：**40**
* **背景负样本（200）**

  * 空产线/空仓道：**90**
  * 仅设备/货架：**70**
  * 高纹理/花纹墙面/标识牌：**30**
  * LED 看板/镜面反射：**10**

---

# 采样与覆盖要点（务实清单）

* **机位覆盖**：每个相机都抽样（每路 ≥15–30 张），不同角度/高度/视场。
* **时间分布**：白天/黄昏/夜间；班中灯光开关变化；雨天潮湿反光地面。
* **压缩混合**：高/低码率各占一部分（可以将原片另存为 JPG Q=40 产生压缩伪影）。
* **去重**：同一机位相邻帧做去重（感知哈希/直方图相似度），避免连拍淹没统计。
* **困难样本精挑**：背光人像发黑、反光安全帽“发白”、马甲荧光过曝、叉车挡住人体上半身。
* **负样本要“像真”**：空场景但保留极易误检元素（警示条纹、格栅、广告画、强几何纹理、LED 走字）。

---

# 标注与预处理

* **校准不强制标注**，但建议“未佩戴/不规范”与“困难样本”人工确认一下确有目标。
* **预处理必须与线上一致**：resize/letterbox、BGR↔RGB、mean/std、归一化、颜色空间。
* **批大小**：1–32，关键是把所有校准图跑一遍（可乱序）。

---

# 量化方法与参数建议

* **方法**：Percentile（如 **99.9%**）或 KL。背景占比较高时，Percentile 往往更稳。
* **层级策略**：对检测头/小目标敏感层可用更“紧”的百分位（如 99.5%）对抗 outlier；骨干可 99.9%。
* **稳定性自检**：全量跑两遍比对每层 min/max 差异；若差异 >10–15%，增加样本或平衡分布。

---

# 快速抽帧与检视（可选）

* 每路视频按 **1–2 秒/帧**等间隔抽帧，简单去重后入库。
* 低码率模拟：将一部分抽帧用脚本另存为 `JPEG Q=40` 版本纳入“困难/背景”。

---

如果你愿意，我还能把上面的配方**按你的具体相机数量/场景权重**（例如仓库通道占 50%，产线占 30%，装卸区占 20%）细化成**各场景的张数配额表**，以及给一段**一键抽帧+去重的小脚本**。
